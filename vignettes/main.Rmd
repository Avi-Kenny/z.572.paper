---
title: "572 Paper Reproduction"
output: rmarkdown::word_document
vignette: >
  %\VignetteIndexEntry{main}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Load packages
```{r}

library(z.572.paper)
library(sp)
library(rgeos)
library(spdep)
library(parallel)
library(rgdal)
library(simba)
library(ggplot2)
library(dplyr)
library(magrittr)
library(permute)
library(maps)
library(maptools)
library(mvtnorm)
library(rjags) # !!!!! On hutch load module: JAGS/4.2.0-foss-2016b

```



# Generate objects to be used throughout code
```{r}

adj_mtx_path <- generate_graph_path() %>% adj_from_graph()
adj_mtx_grid <- generate_graph_grid() %>% adj_from_graph()
adj_mtx_US <- adj_from_gis_us()

```



# Generate figure 1
```{r}

rhos <- seq(from=0.1, to=0.9, by=0.1)
rho_out <- c()

for (adj_mtx in list(adj_mtx_path, adj_mtx_grid, adj_mtx_US)) {
  
  for (rho in rhos) {
    
    # Generate average neighbor-pair correlation for DAGAR
    mtx_dagar <- generate_mtx(model="DAGAR", adj_mtx=adj_mtx, rho=rho)
    cov_dagar <- solve(mtx_dagar$Q)
    
    cor <- 0
    count <- 0
    for (i in 2:length(mtx_dagar$neighbors)) {
      
      nbs <- mtx_dagar$neighbors[[i]]
      if (nbs[1]!=0) {
        for (nb in 1:length(nbs)) {
          j <- nbs[nb]
          cor <- cor + ( cov_dagar[i,j] / 
            (sqrt(cov_dagar[i,i]) * sqrt(cov_dagar[j,j])) )
          count <- count+1
        }
      }
      
    }
    anpc_dagar <- cor/count
    rho_out <- c(rho_out, anpc_dagar)
    
    # Generate average neighbor-pair correlation for CAR
    mtx_car <- generate_mtx(model="CAR", adj_mtx=adj_mtx, rho=rho)
    cov_car <- solve(mtx_car$Q)
    cor <- 0
    count <- 0
    for (i in 1:length(mtx_car$neighbors)) {
      
      nbs <- mtx_car$neighbors[[i]]
      if (nbs[1]!=0) {
        for (nb in 1:length(nbs)) {
          j <- nbs[nb]
          cor <- cor + ( cov_car[i,j] / 
            (sqrt(cov_car[i,i]) * sqrt(cov_car[j,j])) )
          count <- count+1
        }
      }
      
    }
    anpc_car <- cor/count
    rho_out <- c(rho_out, anpc_car)
  
  }

}

# Plot results
ggplot(
  data = data.frame(
    x = rep(rep(rhos, each=2), 3),
    y = rho_out,
    grp = rep(c("DAGAR","CAR"), 27),
    type = rep(c(
      "(a) Path graph of length 100",
      "(b) 10 x 10 grid",
      "(c) 48 contiguous US states"
    ), each=18)
  ),
  aes(x=x, y=y, group=grp,
      color=as.factor(grp))) + 
  geom_segment(x=0, y=0, xend=1, yend=1, color="grey") +
  geom_line() + geom_point(size=3) +
  scale_color_manual(values=c("firebrick", "darkolivegreen4")) +
  xlim(0,1) +
  ylim(0,1) +
  facet_wrap(~type, ncol=3) +
  labs(
    title = paste0("Figure 1. Average neighbor pair correlations as a function",
                   " of rho for proper CAR and DAGAR model"),
    x = "rho",
    y = "Average neighbor correlation",
    color = "Model"
  ) +
  theme(legend.position = "bottom")

```



# Generate figure 2
```{r}

rd_path <- function(p) {
  sqrt(
    (4*p^8 + 2*p^4) / ( (3+6*p^2+p^4)^2 + (18*p^2*(1+p^2)^2) + (2*p^4) )
  )
}

s <- function(p) {
  1 / ( 1 + (1-1)*p^2 ) +
  2 / ( 1 + (2-1)*p^2 ) +
  3 / ( 1 + (3-1)*p^2 ) +
  4 / ( 1 + (4-1)*p^2 )
}

rd_grid <- function(p) {
  sqrt(
    (
      p^4 * ( s(p)/5 - 2/(1+p^2) )^2 +
      2 * ( 1/3 - s(p)/30 - p^2/(1+p^2) )^2 +
      12 * ( 1/6 - s(p)/60 )^2
    ) /
    (
      ( 1 + p^2 + p^2*(s(p)/5) )^2 +
      4 * p^2 +
      20 * ( 1/6 - s(p)/60 )^2
    )
  )
}

# Generate data
n <- 101
rhos <- seq(from=0, to=1, length.out=n)

# Plot results
ggplot(
  data = data.frame(
    x = rep(rhos, 2),
    y = c( rd_path(rhos), rd_grid(rhos) ),
    grp = rep(c("(a) Path graph","(b) Grid graph"), each=n)
  ),
  aes(x=x, y=y, group=grp)
) +
  geom_line() + 
  geom_text(
    data = data.frame(
      x = rep(seq(from=0, to=1, by=0.25), 2),
      y = c(
        round(rd_path(c(0, 0.25, 0.5, 0.75, 1)),2),
        round(rd_grid(c(0, 0.25, 0.5, 0.75, 1)),2)
      ),
      grp = rep(c("(a) Path graph", "(b) Grid graph"), each=5)
    ),
    aes(x=x, y=y, label=y),
    size = 2
  ) +
  xlim(0,1) +
  # ylim(0,1) +
  facet_wrap(~grp, ncol=2) +
  labs(
    title = paste0("Figure 2. Asymptotic relative difference between the DAGAR",
                   "model and the order free DAGAR model"),
    x = "rho",
    y = "Relative difference"
  )

```



# Main simulation
```{r}

set.seed(1)

sim <- new_sim()

sim %<>% set_config(
  num_sim = 10, # !!!!!
  parallel = "outer",
  packages = c("z.572.paper", "sp", "rgeos", "spdep", "parallel", "rgdal",
               "simba", "ggplot2", "dplyr", "magrittr", "permute", "maps", 
               "maptools", "mvtnorm", "rjags")
)

sim %<>% add_constants(
  tau_w = 0.25,
  adj_mtx_path = generate_graph_path() %>% adj_from_graph(),
  adj_mtx_grid = generate_graph_grid() %>% adj_from_graph(),
  adj_mtx_US = adj_from_gis_us()
)

# sim %<>% add_method( "m", function(x) { return (x) } )

sim %<>% set_levels(
  type = c("path", "grid", "US"),
  rho = seq(from=0.1, to=0.9, by=0.1),
  model = c("iCAR", "CAR", "DAGAR", "Scaled iCAR")
  # type = "path",
  # rho = 0.5,
  # model = c("iCAR", "DAGAR")
)

sim %<>% add_creator(generate_dataset)

sim %<>% add_script(
  "script_mainsim",
  function(L,C) {
    
    # Set variables depending on `type`
    switch(
      L$type,
      "path" = {
        k <- 100
        adj_mtx <- C$adj_mtx_path
      },
      "grid" = {
        k <- 100
        adj_mtx <- C$adj_mtx_grid
      },
      "US" = {
        k <- 48
        adj_mtx <- C$adj_mtx_US
      }
    )
    
    # Generate data
    data <- generate_dataset(
      type = L$type,
      tau_w = C$tau_w,
      phi = -1*log(L$rho)
    )
    
    # Create necessary matrices and objects to send to JAGS (depending on model)
    # Create JAGS code
    
    if (L$model %in% c("iCAR", "CAR", "Scaled iCAR")) {
      mtx <- generate_mtx(L$model, adj_mtx)
      D <- mtx$D
      n_i <- mtx$n_i
    }
    
    if (L$model %in% c("iCAR", "Scaled iCAR")) {
      # Perturbation (to account for singularity of Q)
      perturb = diag(rep(10^-6,k))
    } else {
      perturb = NULL
    }
    
    if (L$model == "iCAR") {
      
      # JAGS model code
      jags_code <- quote("
        model {
          for (i in 1:k) {
            y[i] ~ dnorm(x1[i]*beta1 + x2[i]*beta2 + w[i], tau_e)
          }
          
          w ~ dmnorm(mu0, Q)
          Q <- tau_w * (D-A) + perturb
          
          beta1 ~ dnorm(0, 0.0001)
          beta2 ~ dnorm(0, 0.0001)
          tau_w ~ dgamma(2, 1)
          tau_e ~ dgamma(2, 0.1)
        }
      ")
      
    }
    
    if (L$model == "Scaled iCAR") {
      
      sigma2ref <- exp(mean(log(diag(ginv(D - adj_mtx)))))
      
      # JAGS model code
      jags_code <- quote("
        model {
          for (i in 1:k) {
            y[i] ~ dnorm(x1[i]*beta1 + x2[i]*beta2 + w[i], tau_e)
          }
          
          w ~ dmnorm(mu0, Q)
          Q <- tau_w * (D-A) + perturb
          
          beta1 ~ dnorm(0, 0.0001)
          beta2 ~ dnorm(0, 0.0001)
          tau_w ~ dgamma(2, sigma2ref)
          tau_e ~ dgamma(2, 0.1)
        }
      ")
      
    } else {
      sigma2ref <- NULL
    }
    
    if (L$model == "CAR") {
      
      # JAGS model code
      jags_code <- quote("
        model {
          for (i in 1:k) {
            y[i] ~ dnorm(x1[i]*beta1 + x2[i]*beta2 + w[i], tau_e)
          }
          
          w ~ dmnorm(mu0, Q)
          Q <- tau_w * (D - (rho*A))
          
          beta1 ~ dnorm(0, 0.0001)
          beta2 ~ dnorm(0, 0.0001)
          tau_w ~ dgamma(2, 1)
          tau_e ~ dgamma(2, 0.1)
          rho ~ dunif(0, 1)
        }
      ")
      
    }
    
    if (L$model %in% c("DAGAR", "DAGAR_OF")) {
      
      mtx <- generate_mtx(L$model, adj_mtx)
      n_i <- mtx$n_i

      # JAGS model code
      jags_code <- quote("
        model {
          for (i in 1:k) {
            y[i] ~ dnorm(x1[i]*beta1 + x2[i]*beta2 + w[i], tau_e)
          }
          
          w ~ dmnorm(mu0, Q)
          Q <- tau_w * (t(L) %*% FF %*% L)
          L <- I - B
          
          for (i in 1:k) {
            for (j in 1:k) {
              
              FF[i,j] <- ifelse(i==j, tau[i], 0)
              B[i,j] <- ifelse(
                j<i && A[i,j]==1,
                rho / (1+(n_i[i]-1)*(rho^2)),
                0
              )
              
            }
          }
          
          tau <- (1+(n_i-1)*(rho^2)) / (1-rho^2)
          
          beta1 ~ dnorm(0, 0.0001)
          beta2 ~ dnorm(0, 0.0001)
          tau_w ~ dgamma(2, 1)
          tau_e ~ dgamma(2, 0.1)
          rho ~ dunif(0, 1)
        }
      ")
      
    } else {
      n_i <- NULL
    }
    
    if (L$model == "DAGAR") {
      # !!!!! TO DO
    }
    
    if (L$model == "DAGAR_OF") {
      # !!!!! think about approximating this with a sample of 10 permutations
    }
    
    if (L$model == "Sparse SGLMM") {
      # !!!!! TO DO
    }
    
    # Run JAGS model
    jm <- jags.model(
      file = textConnection(jags_code),
      data = list(
        k = k,
        x1 = data$x1,
        x2 = data$x2,
        y = data$y,
        D = D,
        I = diag(rep(1,k)),
        A = adj_mtx,
        n_i = n_i,
        sigma2ref = sigma2ref,
        perturb = perturb,
        mu0 = rep(0,k)
      ),
      n.chains = 1,
      n.adapt = 1000
    )
    output <- coda.samples(
      model = jm,
      variable.names = "w",
      n.iter = 1000,
      thin = 1
    )
    # summary(output)
    
    # Calculate MSE
    w_hat <- as.numeric(summary(output)$quantiles[,"50%"])
    mse <- mean((data$w-w_hat)^2)
    
    return (list("mse" = mse))
    
  }
)

sim %<>% run("script_mainsim")

sim %>% summary() %>% arrange(model, type, rho)

saveRDS(sim, file="sim")
# readRDS("sim")

```
