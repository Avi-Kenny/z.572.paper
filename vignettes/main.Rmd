---
title: "572 Paper Reproduction"
output: rmarkdown::word_document
vignette: >
  %\VignetteIndexEntry{main}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}

library(z.572.paper)
library(sp)
library(rgeos)
library(spdep)
library(rgdal)
library(ggplot2)
library(dplyr)
library(magrittr)
library(permute)

set.seed(1)

```



# TO DO
- Add tau_w parameter to create_cov_dagar and create_cov_car
- ...



# Generate datasets
```{r}

# generate_dataset(type="path", rho=0.1)

```



# Figure 1
```{r}

adj_mtx_path <- generate_graph_path() %>% adj_from_graph()
adj_mtx_lat <- generate_graph_lattice() %>% adj_from_graph()
adj_mtx_us <- adj_from_gis_us()

rhos <- seq(from=0.1, to=0.9, by=0.1)
rho_out <- c()

for (adj_mtx in list(adj_mtx_path, adj_mtx_lat, adj_mtx_us)) {
  
  for (rho in rhos) {
    
    # Generate average neighbor-pair correlation for DAGAR
    cov_dagar <- generate_cov_dagar(adj_mtx, rho)
    cor <- 0
    count <- 0
    for (i in 2:length(cov_dagar$neighbors)) {
      
      nbs <- cov_dagar$neighbors[[i]]
      if (nbs[1]!=0) {
        for (nb in 1:length(nbs)) {
          j <- nbs[nb]
          cor <- cor + ( cov_dagar$mtx_cov[i,j] / 
            (sqrt(cov_dagar$mtx_cov[i,i]) * sqrt(cov_dagar$mtx_cov[j,j])) )
          count <- count+1
        }
      }
      
    }
    anpc_dagar <- cor/count
    rho_out <- c(rho_out, anpc_dagar)
    
    # Generate average neighbor-pair correlation for CAR
    cov_car <- generate_cov_car(adj_mtx, rho)
    cor <- 0
    count <- 0
    for (i in 1:length(cov_car$neighbors)) {
      
      nbs <- cov_car$neighbors[[i]]
      if (nbs[1]!=0) {
        for (nb in 1:length(nbs)) {
          j <- nbs[nb]
          cor <- cor + ( cov_car$mtx_cov[i,j] / 
            (sqrt(cov_car$mtx_cov[i,i]) * sqrt(cov_car$mtx_cov[j,j])) )
          count <- count+1
          
        }
      }
      
    }
    anpc_car <- cor/count
    rho_out <- c(rho_out, anpc_car)
  
  }

}

# Plot results
ggplot(
  data = data.frame(
    x = rep(rep(rhos, each=2), 3),
    y = rho_out,
    grp = rep(c("DAGAR","CAR"), 27),
    type = rep(c(
      "(a) Path graph of length 100",
      "(b) 10 x 10 grid",
      "(c) 48 contiguous US states"
    ), each=18)
  ),
  aes(x=x, y=y, group=grp,
      color=as.factor(grp))) + 
  geom_segment(x=0, y=0, xend=1, yend=1, color="grey") +
  geom_line() + geom_point(size=3) +
  scale_color_manual(values=c("firebrick", "darkolivegreen4")) +
  xlim(0,1) +
  ylim(0,1) +
  facet_wrap(~type, ncol=3) +
  labs(
    title = paste0("Figure 1. Average neighbor pair correlations as a function",       " of rho for proper CAR and DAGAR model. The solid gray line represents",
      " x = y line."),
    x = "rho",
    y = "Average neighbor correlation",
    color = "Model"
  ) +
  theme(legend.position = "bottom")

```
